<?xml version="1.0"?>
<launch>
  <!-- Listen to messages from joysicks -->
  <node pkg="joy" name="joy_node" type="joy_node">
  <param name="autorepeat_rate" value="2"/>
  </node>

  <!-- launch vesc driver node -->
  <node pkg="vesc_driver" name="vesc_driver_node" type="vesc_driver_node">
  <param name="port" value="/dev/sensors/vesc" />
  <param name="serial_baudrate"     type="int"    value="115200"/>
  </node>

  <!--  launch rplidar driver node-->
  <node pkg="rplidar_ros" name="rplidarNode" type="rplidarNode">
  <param name="port" value="/dev/sensors/rplidar" />
  <param name="frame_id" type="string" value="laser"/>
  <param name="inverted"  type="bool"   value="false"/>
  <param name="angle_compensate"  type="bool"   value="true"/>
  <param name="scan_mode"   type="string" value="Boost"/>
  <remap from="scan" to="scan2"/>
  </node>
  
  <!--  launch IMU driver node -->
  <node ns="imu" name="imu_node" pkg="imu_bno055" type="bno055_i2c_node" respawn="true" respawn_delay="2">
     <param name="device" type="string" value="/dev/i2c-1"/>
     <param name="address" type="int" value="40"/> <!-- 0x28 == 40 is the default for c -->
     <param name="frame_id" type="string" value="imu"/>
     <!-- remap from="/imu/data" to="/imu" -->
    </node>
   

 <node pkg="tf2_ros" type="static_transform_publisher" name="base_link_to_imu" 
        args="0.01286 0.0 0.06119    0.0 0.0 0.7071067811865475 0.7071067811865475 base_link imu" />

 <node pkg="tf2_ros" type="static_transform_publisher" name="base_link_to_laser" 
        args="0.01286 0.0 0.076 0.0 0.0 1.0 0.0 base_link laser" />

  <!-- Launch the mux node with the parameters from params.yaml -->
  <node pkg="f1tenth_simulator" name="mux_controller" type="mux" output="screen">
    <rosparam command="load" file="$(find f1tenth_simulator)/params.yaml"/>
  </node>


  <node pkg="f1tenth_simulator" name="racecar_experiment" type="experiment" output="screen">
    <rosparam command="load" file="$(find f1tenth_simulator)/params.yaml"/>
  </node>

  <!-- Launch the behavior controller node with the parameters from params.yaml -->
  <node pkg="f1tenth_simulator" name="behavior_controller" type="behavior_controller" output="screen">
    <rosparam command="load" file="$(find f1tenth_simulator)/params.yaml"/>
  </node>

  <!-- Launch the Keyboard Node -->
  <node pkg="f1tenth_simulator" name="keyboard" type="keyboard" output="screen">
    <rosparam command="load" file="$(find f1tenth_simulator)/params.yaml"/>
  </node>

  <node pkg="f1tenth_simulator" name="collision_assistance" type="collision_assistance.py" output="screen">
    <rosparam command="load" file="$(find f1tenth_simulator)/params.yaml"/>
  </node>
  
  <node pkg="f1tenth_simulator" name="navigation" type="navigation.py" output="screen">
    <rosparam command="load" file="$(find f1tenth_simulator)/params.yaml"/>
  </node>

 <!--Launch the detectnet node-->
	<!-- VIDEO SOURCE -->
	<arg name="input" default="v4l2:///dev/video2"/>
	<arg name="input_width" default="0"/>
	<arg name="input_height" default="0"/>
	<arg name="input_codec" default="unknown"/>
	<arg name="input_loop" default="0"/>

	<include file="$(find ros_deep_learning)/launch/video_source.ros1.launch">
		<arg name="input" value="$(arg input)"/>
		<arg name="input_width" value="$(arg input_width)"/>
		<arg name="input_height" value="$(arg input_height)"/>
		<arg name="input_codec" value="$(arg input_codec)"/>
		<arg name="input_loop" value="$(arg input_loop)"/>
	</include>

<!-- DETECTNET -->
	<arg name="model_name" default="ssd-mobilenet-v2"/>
	<arg name="model_path" default=""/>
	<arg name="prototxt_path" default=""/>
	<arg name="class_labels_path" default=""/>
	<arg name="input_blob" default="data"/>
	<arg name="output_cvg" default="coverage"/>
	<arg name="output_bbox" default="bboxes"/>
	<arg name="overlay_flags" default="box,labels,conf"/>
	<arg name="mean_pixel_value" default="0.0"/>
	<arg name="threshold" default="0.5"/>

	<node pkg="ros_deep_learning" type="detectnet" name="detectnet" output="screen">
		<remap from="/detectnet/image_in" to="/video_source/raw"/>
		<param name="model_name" value="$(arg model_name)"/>
		<param name="model_path" value="$(arg model_path)"/>
		<param name="prototxt_path" value="$(arg prototxt_path)"/>
		<param name="class_labels_path" value="$(arg class_labels_path)"/>
		<param name="input_blob" value="$(arg input_blob)"/>
		<param name="output_cvg" value="$(arg output_cvg)"/>
		<param name="output_bbox" value="$(arg output_bbox)"/>
		<param name="overlay_flags" value="$(arg overlay_flags)"/>
		<param name="mean_pixel_value" value="$(arg mean_pixel_value)"/>
		<param name="threshold" value="$(arg threshold)"/>
	</node>

	<!-- VIDEO OUTPUT -->
	<arg name="output" default="display://0"/>
	<arg name="output_codec" default="unknown"/>
	<arg name="output_bitrate" default="0"/>

	<include file="$(find ros_deep_learning)/launch/video_output.ros1.launch">
		<arg name="topic" value="/detectnet/overlay"/>
		<arg name="output" value="$(arg output)"/>
		<arg name="output_codec" value="$(arg output_codec)"/>
		<arg name="output_bitrate" value="$(arg output_bitrate)"/>
	</include>

</launch>

